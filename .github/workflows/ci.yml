name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-gate:
    name: Build Gate
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: Check for untracked files
        run: |
          bash scripts/ci/check_untracked.sh

      - name: Generate READMEs
        run: |
          bash scripts/gen_readme.sh

      - name: Check README freshness
        run: |
          bash scripts/ci/check_readme_fresh.sh

  test-core:
    name: Test Core
    runs-on: macos-latest
    needs: build-gate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2

      - name: Install dependencies
        run: |
          cd packages/cloudplayplus_core
          flutter pub get

      - name: Run tests
        run: |
          cd packages/cloudplayplus_core
          flutter test

      - name: Check coverage
        run: |
          cd packages/cloudplayplus_core
          flutter test --coverage

  test-protocol:
    name: Test Protocol
    runs-on: macos-latest
    needs: build-gate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: Run tests
        run: |
          cd packages/itermremote_protocol
          dart pub get
          dart test

  test-observability:
    name: Test Observability
    runs-on: macos-latest
    needs: build-gate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: Run tests
        run: |
          cd src/modules/observability
          dart pub get
          dart test

  test-daemon-ws:
    name: Test Daemon WS
    runs-on: macos-latest
    needs: build-gate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: Run tests
        run: |
          cd src/modules/daemon_ws
          dart pub get
          dart test || echo "No tests yet in daemon_ws"

  test-host:
    name: Test Host
    runs-on: macos-latest
    needs: build-gate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2

      - name: Install dependencies
        run: |
          cd packages/iterm2_host
          flutter pub get

      - name: Run tests (pure logic only, skip iTerm2-dependent)
        run: |
          cd packages/iterm2_host
          dart test --exclude-tags=iterm2

  test-host-console:
    name: Test Host Console
    runs-on: macos-latest
    needs: build-gate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2

      - name: Install dependencies
        run: |
          cd apps/host_console
          flutter pub get

      - name: Run tests
        run: |
          cd apps/host_console
          flutter test

  build-host-daemon:
    name: Build Host Daemon
    runs-on: macos-latest
    needs: build-gate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2

      - name: Install dependencies
        run: |
          cd apps/host_daemon
          flutter pub get

      - name: Build macOS
        run: |
          cd apps/host_daemon
          flutter build macos

  build-host-console:
    name: Build Host Console
    runs-on: macos-latest
    needs: build-gate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2

      - name: Install dependencies
        run: |
          cd apps/host_console
          flutter pub get

      - name: Build macOS
        run: |
          cd apps/host_console
          flutter build macos

  # WS API schema/build check (pure logic, no iTerm2)
  check-ws-api:
    name: Check WS API
    runs-on: macos-latest
    needs: build-gate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2

      - name: Check WS API
        run: |
          bash scripts/ci/check_ws_api.sh

  # NOTE:
  # iTerm2-related E2E (panel switching / crop / loopback / screenshots) is NOT
  # suitable for GitHub-hosted CI runners due to missing iTerm2 app, GUI session,
  # and macOS privacy permissions (Screen Recording / Accessibility).
  #
  # Keep those regressions as a local/self-hosted runner workflow.
