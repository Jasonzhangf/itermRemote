# AGENTS.md

本文件定义本仓库的强制规则与开发流程，所有自动化与人工提交必须遵守。

## 核心原则

1. **从小开始构建**：每个模块先实现基础版本，通过功能测试后才能提交。
2. **测试先行**：新增任何功能必须有完整单元测试；可做 E2E 的最终必须做一次端到端测试。
3. **持续可用**：每次提交必须能构建、能通过测试、能通过 CI。

## Build Gate（强制）

1. **未跟踪文件阻断构建**：
   - 在 `packages/` 或 `apps/` 下发现未被 git 跟踪的文件时，构建必须失败。
   - 允许的临时文件必须放在 `.gitignore` 忽略目录（如 `build/`、`.dart_tool/`）。

2. **README 必须最新**：
   - 每个模块的 `README.md` 必须由自动生成脚本产出。
   - 构建前会重新生成 README，若与提交内容不一致则构建失败。

## README 规范（强制）

每个模块目录必须包含：

- `README.md`（自动生成，禁止手工改写）
- `DEBUG_NOTES.md`（可选，建议维护）
- `ERROR_LOG.md`（可选，建议维护）
- `UPDATE_HISTORY.md`（可选，建议维护）

生成内容必须包含：

- 模块架构说明
- 每个文件的说明（优先读取头部 `///` 注释）
- 调试经验与错误记录
- 更新历史

## CI / CD 规则（强制）

1. CI 必须包含：
   - build gate（未跟踪文件检查）
   - README freshness 检查
   - 各模块单元测试
   - E2E 测试（条件具备时）

2. 只有 CI 全绿的 commit 才允许合并。

## 运行时监控规则（强制）

1. 内存监控必须作为系统级常驻服务运行（launchd）。禁止依赖 wrapper 脚本来启动监控。
2. 监控服务配置模板：`scripts/itermremote.memory-monitor.plist`。
3. 默认监控脚本：`scripts/monitor_memory.py`，默认目标进程名：`host_test_app`。
4. 日志/状态文件必须写入可写目录（推荐 `/tmp/itermremote-memory-monitor` 或通过 `--state-dir` 指定）。

## 模块交付规则

1. 模块必须按阶段交付：
   - Phase 0: 基础设施 + 目录结构 + CI
   - Phase 1: Core 模块最小闭环
   - Phase 2: Host 模块最小闭环
   - Phase 3: Android 客户端最小闭环
   - Phase 4: E2E 测试闭环

2. 每个阶段完成必须满足：
   - 单测覆盖率达标
   - README 最新
   - CI 通过

## 提交策略

1. **每次提交必须可用**：
   - 通过所有测试
   - 可构建

2. **功能拆分提交**：
   - 每个功能在独立提交中完成（避免混合变更）

3. **测试与功能绑定**：
   - 功能实现与测试必须在同一提交中出现
